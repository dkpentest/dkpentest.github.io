<!DOCTYPE html>
<html class="no-js" lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="theme-color" content="#1b1b1b">
	<title>Network_basics | drunk for pentest</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="stylesheet" href="/css/bundle.css">
	<link rel="icon" href="/icons/16.png" sizes="16x16" type="image/png">
	<link rel="icon" href="/icons/32.png" sizes="32x32" type="image/png">
		
</head>
<body class="body kind-page">
	<header class="header">
	<a class="logo" href="/">drunk for pentest</a>
	
</header>
	<div class="primary">
	
	<main class="main">
		
		<div class="single block">
			<article class="entry">
				<h1 class="entry__title">Network_basics</h1>
				<div class="entry__content"><h3 id="网络基础">网络基础</h3>
<p>本文简要整理渗透过程中所涉及的本地网络、运营商网络、虚拟专用网络基础知识，总是忘记，常看常新。</p>
<h4 id="网络模型和地址">网络模型和地址</h4>
<p>OSI七层模型（理论模型，现有模型后有协议、现有标准后有实践）<br>
TCP/IP模型（事实模型，现有协议应用，后有参考OSI模型）</p>
<p>比如，192.168.1/24（这里24是子网掩码24位）</p>
<pre tabindex="0"><code>OSI理论模型                            TCP/IP总结模型
-----                                 -----
应用层（应用程序服务）                              HTTP、FTP
表示层（数据格式转化、数据加密）           应用层      Telnet
会话层（建立、管理和维护会话）                       SMTP、DNS
-----                                 -----
传输层（建立、管理和维护端到端的连接）      传输层      TCP、UDP
-----                                 -----
网络层（IP选址及路由选择）                网络层     IP、ICMP、ARP
-----                                 -----
数据链路层（提供介质访问和链路管理          数据链路层 IEEE 802.1-11
物理层（物理层）
-----
</code></pre><p>因为下一层的 payload 就是 上一层的 header + payload，越往下报文越长，具体单位：
传输层：TCP 的 segement（段）、UDP 的 datagram<br>
网络层：IP 的 packet（包）
链路层：Ethernet 的 frame（帧）
物理层：bit 比特</p>
<h4 id="tcpip协议网络地址">TCP/IP协议网络地址</h4>
<pre tabindex="0"><code>A类地址：0+7位网络地址 + 24位主机地址
1.0.0.0～127.255.255.255
B类地址：10+14位网络地址 + 16位主机地址
128.0.0.0～191.255.255.255
C类地址：110+21位网络地址 + 8位主机地址
192.0.0.0～233.255.255.255
D类地址：1110 + 多目的广播地址28位
224.0.0.0～ 
E类地址：11110 保留用于实验
240.0.0.0～ 
特殊地址：
host ID 全为1的地址为：广播地址
本地：127.0.0.1
</code></pre><hr>
<h3 id="0x1-运营商网络">0x1 运营商网络</h3>
<p>运营商：PON组网，Qin.q双层vlan，光线入户</p>
<p>家庭路由器，本质上是运营商级（CGN Carrier-Grade NAT 或 LSN Large-Scale NAT）NAT网络中的一个动态分配IP节点（意思就是一小个IP池后面映射多个端点，以缓解IPV4地址不足，每次路由器重启都要重新分配公网IP）</p>
<p>这里如果想要家庭网络拥有公网IP（监控也好、提供网络服务也好），需要向运营商提出申请。</p>
<hr>
<h3 id="0x2-基础工具">0x2 基础工具</h3>
<p>ifconfig en0：这是个过时的指令（建议用ip addr、ip link替代）用于查看或设置网卡</p>
<pre tabindex="0"><code>mac 和 linux 的指令输出差异会比较大，以 linux 为例：
（冷知识：这里 if 是 interface 的意思，windows 那个 ipconfig 是 internet protocol 缩写）
字段释义：
    eth1    这是网卡名称，类似还有eht1、lo、docker0、en0等，eth1通常是物理网卡
    flags   当前状态
    mtu     最大传输单元 maximum transger unit，通常是 1500 byte 
    inet    TCP/IP 的 ipv4 地址，netmask子网掩码、broadcst广播地址
    inet6   TCP/IP 的 ipv6 地址
    ether   以太网，表示网卡的 mac地址
    txqueuelen  发送数据时 qdisc 队列长度 
    rx      接收数据的大小
    tx      发送数据的大小 
</code></pre><p>networksetup -listallhardwareports 让mac列举所有网卡</p>
<pre tabindex="0"><code>bridge0：thunderbolt bridge
en0: wifi
en1: thunderbolt 1
en2: thunderbolt 2
en3: thunderbolt 3
en4: thunderbolt 4
(这台mac设备有四个物理插口，那么其他ifconfig能扫出来的自然是虚拟网卡了，例如：)
lo0: 回环网卡，最常用地址是 127.0.0.1 
gif0: 通用 IP-in-IP隧道
stf0: 6to4连接
en5: ? 不知道设备哪来的第五个硬件口 en5
ap1: 启用热点
awdl0: airdrop 设备特有
llw0: link-local 是一种 ipv6协议
utun0～3: vpn 或 back to my mac 
</code></pre><p>防火墙管理工具
linux下：iptables（ubuntu）、ufw（ubuntu）、firewall（centos）、以及TCP wrappers（这个都自带）
mac下：pfctl</p>
<pre tabindex="0"><code>iptables：
iptables和firewall本身不是防火墙，只是防火墙管理工具，iptables由四表五链组成
四表（应用顺序 raw-mangle-nat-filter）：
    raw：决定是否进行状态跟踪
    mangle：修改数据包的服务类型、生命周期等
    nat：修改数据包的ip地址、端口号（常用）
    filter：设置处理规则（默认）
五链（应用顺序取决于数据流向）：
    INPUT：应用在访问本机数据包
    OUTPUT：应用在本机发送数据包
    FORWARD：应用在需要转发数据包
    PREROUTING：应用在做路由选择前
    POSTROUTING：应用在做路由选择后
控制选项：
    ACCEPT：允许通过
    REJECT：拒绝并响应
    DROP：丢弃不响应
    LOG：计日志，不处理，给下一条规则
识别规则的顺序是匹配即停止
示例：
iptables -L 查看所有规则
iptables -t filter -A INPUT -s 192.168.100.0/24 -j ACCEPT 往filter表里添加来源于这个网段的访问规则
iptables -D INPUT 1 删除第一条规则 
（先表名，后链名）

firewall的特点是可以设置规则域，如办公区域、家庭区域
示例：
firewall-cmd --panic-on 阻断一切网络连接

TCP wrapper 是通过修改文件 /etc/hosts.allow /etc/hosts.deny 等等来实现  

pfctl 通过修改文件 /etc/pf.conf 来实现
示例：
pfctl -sa 显示任何可以显示的
</code></pre><p>一般不太需要更改这个，像VPS，本身的防火墙管理不是在agent实现的，而是通过控制台在宿主机上配置的</p>
<p>进程管理</p>
<pre tabindex="0"><code>pstree: 查看进程间关系

ps：显示所有进程
    ps -e 显示所有进程
    ps --pid 1234 显示特定进程
    ps -l 列出详细信息
        F
        S
        UID
        PID
        PPID
        C
        PRI
        NI
        ADDR
        SZ
        WCHAN
        TTY     终端次要装置号码
        TIME
        CMD

pgrep：查看某个进程状态
    pgrep sshd

kill：杀死进程
    kill 1234
    kill -9 1234 强制终止进程

pkill：ps和kill的结合

vmstat：监控工具，定期查看内存、CPU使用率等

jobs：查看后台作业

lsof -i :80

netstat -a

后台执行 + &amp; 
</code></pre><hr>
<h3 id="0x3-抓包与网络诊断工具">0x3 抓包与网络诊断工具</h3>
<p>mac 安装 wireshark 就好(破解过程略)</p>
<pre tabindex="0"><code>(待补充)
</code></pre><p>网络诊断工具</p>
<pre tabindex="0"><code>ping：ping 程序本身不是协议，它调用的是ICMP报文
    -s  更改长度
    -c  更改次数
    -R  虽然可以记录途经的ip地址，到达后写进回复ICMP报文里，但是因为报文长度限制最多只能写大概9个地址，明显是不够替代 traceroute 的


linux traceroute
原理：每次发出三个非法端口的UDP报文，TTL递增，服务器反馈端口不可达ICMP报文
    TTL：time to live 是IP协议头里的，每次经过一个网段减1，避免在网络无限存在
    每次从 TTL 1 开始递增发出，并记录最后反馈ICMP的地址，由此画出拓扑
测不准原理：
    反馈的超时包可能从另一个接口发出，并不走原来的路径（路由器当成了正常包来转发）


windows tracert  
原理：每次发出一个ICMP报文，TTL递增，服务器反馈

paris traceroute 
</code></pre><hr>
<h3 id="0x4-嗅探网络拓扑">0x4 嗅探网络拓扑</h3>
<p>（这里比较有意思，回头单独开个post）
网络是个自治系统，每个地方的本地优先级不一样（这决定了ICMP包发送和返回路径不一定相同）</p>
<p>路由器不会记录邻居的路由信息，因此需要通过对端的接口信息推测是否属于同一个自治系统</p>
<p>通过延时计算来推测网络拓扑</p>
<pre tabindex="0"><code>延时有三种
    串行延时：包大小bits/传输速率bps，路由器和交换机发送数据包的时间
    排队延时：在路由器对列里等待的时间，与拥堵程度有关
    传播延时：介质中的传播速度（光纤传播速度一般是 200000km/s，1ms往返延时距离为 100km，赤道环地球一圈是400ms）

traceroute 的包延时包括：
    发送包，路由器生成异常反馈包，返回包
    （这里第二个因为可能被CPU降级，起到延时误导作用）

AS边界常常是策略发生变化的地方，也是有可能出现 traceroute 包发送和返回路径不同的地方
</code></pre><p>交换机和路由器的区别，以家庭宽带为例</p>
<pre tabindex="0"><code>    路由器可以找路，做网间连接，提供防火墙，可以给多个地址配同一个ip 
    交换机只管根据已知mac地址转发 ，做扩大局域网，没有路由功能，性能远高于路由器
    家庭宽带的路径是：
    各种AP（电脑、手机、电视）-&gt; 路由器（LAN、WLAN）-&gt; 光猫 
    （以下开始属于布线工程师，网格优化工程师的传统艺能）
    -&gt; 接入层交换机（直接面对用户，一栋楼一个，低成本，高端口密度）
        customerrouters（AR、Aggr、Cust、CAR、HSA、GW）
    -&gt; 汇聚交换机（三层交换机，提供各种策略实施，减轻核心层压力）
        peeringrouters（BR、Border、Edge、IR、IGR、Peer）
    -&gt; 核心交换机（骨干网，三层交换机，吞吐量可靠性最优）
        Corerouters（CR、Core、GBR、BB、CCR、EBR）
    至此，进入核心网可能要经历三个路由网关，抵达目的地就至少 6+ 路由网管了
</code></pre><hr>
<h3 id="0x5-名词解释">0x5 名词解释</h3>
<pre tabindex="0"><code>LAN     局域网，Local Area Network
VLAN    虚拟局域网，Virtual LAN 
(划分 VLAN 限制广播域、增强安全性、提高健壮性)
PVLAN   私有化VLAN，对上屏蔽下级VLAN数量
ISP     Internet Service Provider 网际网络服务提供商
NOC     network operation center 网络管理中心 
两层交换机  在链路层工作，也叫以太网交换机，没有路由功能
三层交换机  在网络层工作，可以当作路由器（也可以只当交换机）
AS      autonomous system 自治系统或自治域
</code></pre><p>DNS 反向解析</p>
<pre tabindex="0"><code>路由器需要排除不合理的线路规划，所以会根据以下标注
    IATAAirport Codes
    CLLICodes
    CountryCodes 非标准简写城市名
来合理反向解析并合理规划物理线路
</code></pre></div>
				
			</article>
		</div>
	</main>
	
	



	

	</div>
	<footer class="footer">
	<div class="footer__copyright">© 2024 drunk for pentest. <span class="footer__copyright-credits">Powered by <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/vimux/binario" rel="nofollow noopener" target="_blank">Binario</a> theme.</span></div>
</footer>
</body>
</html>